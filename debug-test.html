<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŒ®ç«‹ç”Ÿæˆãƒ‡ãƒãƒƒã‚°</title>
    <style>
        body { font-family: 'Hiragino Sans', Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .result { margin-top: 10px; padding: 15px; background: #f5f5f5; border-radius: 4px; white-space: pre-wrap; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .loading { color: #666; }
        .timing { font-weight: bold; color: #1976d2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ½ï¸ çŒ®ç«‹ç”Ÿæˆæ©Ÿèƒ½ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h1>
        
        <div class="test-section">
            <h2>1. å˜æ—¥çŒ®ç«‹ç”Ÿæˆãƒ†ã‚¹ãƒˆ</h2>
            <p>ä»Šæ—¥ã®æ—¥ä»˜ã§1æ—¥åˆ†ã®çŒ®ç«‹ã‚’ç”Ÿæˆã—ã¦ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å–å¾—ã—ã¾ã™</p>
            <button onclick="testSingleDayGeneration()">å˜æ—¥ç”Ÿæˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <div id="singleDayResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>2. ãƒ¬ã‚·ãƒ”æ•°ç¢ºèªãƒ†ã‚¹ãƒˆ</h2>
            <p>å„é£Ÿäº‹ã‚¿ã‚¤ãƒ—ã®ãƒ¬ã‚·ãƒ”æ•°ã‚’ç¢ºèªã—ã¾ã™</p>
            <button onclick="testRecipeCount()">ãƒ¬ã‚·ãƒ”æ•°ç¢ºèª</button>
            <div id="recipeCountResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>3. é€±é–“çŒ®ç«‹ç”Ÿæˆãƒ†ã‚¹ãƒˆ</h2>
            <p>å¾“æ¥ã®é€±é–“ç”ŸæˆAPIã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™</p>
            <button onclick="testWeeklyGeneration()">é€±é–“ç”Ÿæˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <div id="weeklyResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ</h2>
            <p>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ¥ç¶šã¨ãƒ¬ã‚·ãƒ”å–å¾—ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™</p>
            <button onclick="testDatabaseConnection()">DBæ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
            <div id="dbResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        function showResult(elementId, content, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result ${isSuccess ? 'success' : 'error'}`;
            element.textContent = content;
        }

        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = 'result loading';
            element.textContent = 'â³ å‡¦ç†ä¸­...';
        }

        async function testSingleDayGeneration() {
            showLoading('singleDayResult');
            const startTime = Date.now();
            
            try {
                const response = await fetch('/api/meal-plan/debug-single-day', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: 'demo-user',
                        targetDate: new Date().toISOString().split('T')[0]
                    })
                });

                const data = await response.json();
                const totalTime = Date.now() - startTime;

                let result = `â±ï¸ APIå‘¼ã³å‡ºã—æ™‚é–“: ${totalTime}ms\n`;
                result += `ğŸ“Š ãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${response.ok ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}\n\n`;
                
                if (data.success) {
                    result += `ğŸ¯ ç”Ÿæˆçµæœ:\n`;
                    result += `æœé£Ÿ: ${data.data.breakfast?.name || 'âŒ ãªã—'}\n`;
                    result += `æ˜¼é£Ÿ: ${data.data.lunch?.name || 'âŒ ãªã—'}\n`;
                    result += `å¤•é£Ÿ: ${data.data.dinner?.name || 'âŒ ãªã—'}\n\n`;
                    
                    if (data.data.debug) {
                        result += `ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±:\n`;
                        result += `ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š: ${JSON.stringify(data.data.debug.preferences, null, 2)}\n`;
                        result += `æœ€è¿‘ã®ãƒ¬ã‚·ãƒ”æ•°: ${data.data.debug.recentRecipeIds?.length || 0}\n`;
                        result += `å‡¦ç†æ™‚é–“è©³ç´°: ${JSON.stringify(data.data.debug.timings, null, 2)}\n`;
                    }
                } else {
                    result += `âŒ ã‚¨ãƒ©ãƒ¼: ${data.error}\n`;
                    result += `è©³ç´°: ${data.details}\n`;
                }
                
                showResult('singleDayResult', result, data.success);
            } catch (error) {
                showResult('singleDayResult', `âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}`, false);
            }
        }

        async function testRecipeCount() {
            showLoading('recipeCountResult');
            
            try {
                const response = await fetch('/api/recipes');
                const recipes = await response.json();
                
                const counts = {
                    breakfast: recipes.filter(r => r.category === 'breakfast').length,
                    lunch: recipes.filter(r => r.category === 'lunch').length,
                    dinner: recipes.filter(r => r.category === 'dinner').length,
                    total: recipes.length
                };
                
                let result = `ğŸ“Š ãƒ¬ã‚·ãƒ”æ•°çµ±è¨ˆ:\n`;
                result += `æœé£Ÿ: ${counts.breakfast}ä»¶\n`;
                result += `æ˜¼é£Ÿ: ${counts.lunch}ä»¶\n`;
                result += `å¤•é£Ÿ: ${counts.dinner}ä»¶\n`;
                result += `åˆè¨ˆ: ${counts.total}ä»¶\n\n`;
                
                if (counts.total === 0) {
                    result += `âš ï¸ ãƒ¬ã‚·ãƒ”ãŒ1ä»¶ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
                } else if (counts.breakfast === 0 || counts.lunch === 0 || counts.dinner === 0) {
                    result += `âš ï¸ ä¸€éƒ¨ã®é£Ÿäº‹ã‚¿ã‚¤ãƒ—ã§ãƒ¬ã‚·ãƒ”ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚`;
                } else {
                    result += `âœ… ã™ã¹ã¦ã®é£Ÿäº‹ã‚¿ã‚¤ãƒ—ã§ãƒ¬ã‚·ãƒ”ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚`;
                }
                
                showResult('recipeCountResult', result, counts.total > 0);
            } catch (error) {
                showResult('recipeCountResult', `âŒ ãƒ¬ã‚·ãƒ”å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, false);
            }
        }

        async function testWeeklyGeneration() {
            showLoading('weeklyResult');
            const startTime = Date.now();
            
            try {
                const weekStartDate = new Date();
                weekStartDate.setDate(weekStartDate.getDate() - weekStartDate.getDay());
                
                const response = await fetch('/api/meal-plan/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: 'demo-user',
                        weekStartDate: weekStartDate.toISOString()
                    })
                });

                const data = await response.json();
                const totalTime = Date.now() - startTime;

                let result = `â±ï¸ é€±é–“ç”Ÿæˆæ™‚é–“: ${totalTime}ms\n`;
                result += `ğŸ“Š ãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${response.ok ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}\n\n`;
                
                if (data.success && data.data.plans) {
                    result += `ğŸ“… ç”Ÿæˆã•ã‚ŒãŸçŒ®ç«‹æ•°: ${data.data.plans.length}æ—¥åˆ†\n\n`;
                    data.data.plans.forEach((plan, index) => {
                        const date = new Date(plan.date).toLocaleDateString('ja-JP');
                        result += `${index + 1}æ—¥ç›® (${date}):\n`;
                        result += `  æœé£Ÿ: ${plan.breakfast?.name || 'âŒ ãªã—'}\n`;
                        result += `  æ˜¼é£Ÿ: ${plan.lunch?.name || 'âŒ ãªã—'}\n`;
                        result += `  å¤•é£Ÿ: ${plan.dinner?.name || 'âŒ ãªã—'}\n\n`;
                    });
                } else {
                    result += `âŒ ã‚¨ãƒ©ãƒ¼: ${data.error || 'Unknown error'}\n`;
                    if (data.details) result += `è©³ç´°: ${data.details}\n`;
                }
                
                showResult('weeklyResult', result, data.success);
            } catch (error) {
                showResult('weeklyResult', `âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}`, false);
            }
        }

        async function testDatabaseConnection() {
            showLoading('dbResult');
            
            try {
                const response = await fetch('/api/health');
                const health = await response.json();
                
                let result = `ğŸ¥ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: ${response.ok ? 'âœ… OK' : 'âŒ NG'}\n`;
                result += `ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: ${health.database ? 'âœ… æ¥ç¶šæ¸ˆã¿' : 'âŒ æ¥ç¶šå¤±æ•—'}\n`;
                result += `ã‚¢ãƒ—ãƒª: ${health.status}\n`;
                result += `ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: ${health.timestamp}\n`;
                
                showResult('dbResult', result, response.ok && health.database);
            } catch (error) {
                showResult('dbResult', `âŒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}`, false);
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åŸºæœ¬æƒ…å ±ã‚’è¡¨ç¤º
        window.addEventListener('load', () => {
            console.log('ğŸš€ çŒ®ç«‹ç”Ÿæˆãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«èª­ã¿è¾¼ã¿å®Œäº†');
            console.log('ğŸ“ ç¾åœ¨ã®URL:', window.location.href);
        });
    </script>
</body>
</html>